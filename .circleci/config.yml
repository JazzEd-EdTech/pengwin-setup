version: 2

jobs:
    builddeb:
        docker:
            - image: debian
        environment:
            DEBEMAIL "contact@whitewaterfoundry.com"
            DEBFULLNAME "Whitewater Foundry, Ltd. Co."
        steps:
            - checkout
            - run:
                name: Ensure we have debuild installed
                command: |
                    echo "deb http://ftp.debian.org/debian stretch-backports main" > /etc/apt/sources.list.d/stretch-backports.list
                    apt-get -y -q update
                    apt-get -y -q install -t stretch-backports devscripts debhelper
            - run:
                name: Build the package
                command: debuild -i -us -uc -b
            - run:
                name: Create workspace
                command: mkdir -p /tmp/pkgs
            - run:
                name: Copy package to workspace
                command: cp ../wlinux-setup_0.1-1_all.deb /tmp/pkgs
            - persist_to_workspace:
                root: /tmp/pkgs
                paths: .
    deploydeb:
        docker:
            - image: debian
        steps:
            - attach_workspace:
                 at: /tmp/pkgs
            - run:
                name: Install packageloud cli
                command: gem install package_cloud
            - run:
                name: Push deb package
                command: package_cloud push whitewaterfoundry/wlinux-setup/debian/stretch ../wlinux-setup_0.1-1_all.deb
workflows:
    version: 2
    build:
        jobs:
            - builddeb
            - deploydeb:
                requires:
                    - builddeb
