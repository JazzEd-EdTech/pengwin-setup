#!/bin/bash

SETUPDIR="/etc/wlinux-setup.d"
VERSION="1.2a"

# functions

## core functions

function processarguments {
while [[ $# -gt 0 ]]
do
  case "$1" in
    --debug|-d|--verbose|-v)
      echo "Running in Debug mode"
      set -x
      shift
    ;;
    *)
      shift
    esac
done
}

function welcomeprompt {
whiptail --title "Welcome to WLinux" --msgbox "Thank you for supporting sustainable independent open source development.\n
WLinux comes with a core set of useful packages pre-installed, such as curl, git, and wslu. \n
wlinux-setup allows you to install additional hand-curated selections for WLinux and configure optional WSL-specific settings. \n
Many more packages are available via the apt package manager and optional pip, npm, and RubyGems package managers.\
" 15 96
}

function continueprompt {
if (whiptail --title "Continue setup?" --yesno "Would you like to continue wlinux-setup?" 8 45) then
    echo "Starting wlinux-setup."
else
    echo "Exiting wlinux-setup."
    echo "You may run the script again any time by running: $ wlinux-setup"
    exit 0
fi
}

function updatescriptprompt {
if (whiptail --title "Upgrade setup?" --yesno "Would you like to download and restart with the most recent version of wlinux-setup?\n\nThis is recommended periodically to get new features and fixes." 9 90) then
    createtmp
    echo "Backing up old /etc/setup to /etc/setup.old"
    sudo cp /etc/setup /etc/setup.old
    echo "Getting fresh wlinux-setup from GitHub"
    wget https://github.com/WhitewaterFoundry/WLinux/raw/master/linux_files/setup
    sudo cp setup /etc/setup
    echo "Running updated wlinux-setup"
    touch ~/.updated
    bash /etc/setup
    exit 0
else
    whiptail --title "Release setup" --msgbox "Continuing with built-in wlinux-setup.\n\nIf you encounter problems, please try updating wlinux-setup." 9 90
fi
}

function securitypatches {
echo "Applying Hotpatches"

echo "1: Applying temporary workaround for bug #199"
alias clear="clear -x"
echo 'alias clear="clear -x"' | sudo tee -a /etc/profile

}

function byemessage {
    whiptail --title "Setup is complete." --msgbox "You may run wlinux-setup again any time by typing $ wlinux-setup\n\nYou may open a browser link to get help any time by typing: $ wlinux-help" 8 80
    exit 0
}

## internationalization

function languageprompt {
if (whiptail --title "Language" --yesno "Would you like to configure default keyboard input/language?" 8 65) then
    echo "Running $ dpkg-reconfigure locales"
    sudo dpkg-reconfigure locales
fi
}

## package index

function installmenu {

CHOICE=$(
whiptail --title "wlinux-setup" --checklist --separate-output "\nHand-curated add-ons [SPACE to select, ENTER to confirm]:" 22 99 15 \
    "LANGUAGE" "Change default language and keyboard setting in WLinux" off \
    "EXPLORER" "Enable right-click on folders in Windows Explorer to open them in WLinux  " off \
    "SHELLS" "Install and configure zsh, csh, and fish" off \
    "EDITORS" "Install text editors neovim, emacs, or Visual Studio Code (requires X)" off \
    "PYTHONPI" "Install Python 3.7 and download and install latest PyPi" off \
    "NODEJS" "Install Node.js and npm" off \
    "GO" "Install the latest Go from Google" off \
    "RUBY" "Install Ruby using rbenv and optionally install Rails" off \
    "RUST" "Install latest version of Rust via rustup installer" off \
    "DOTNET" "Install .NET Core SDK from Microsoft and optionally install NuGet" off \
    "JAVA" "Install the Java OpenJDK and JRE" off \
    "POWERSHELL" "Install PowerShell for Linux and/or Azure CLI tools" off \
    "GUI" "Install the basics needed for most GUI apps and configure GUI options" off \
    "DOCKER" "Install a secure bridge to Docker for Windows" off \
    "CASSANDRA" "Install the NoSQL server Cassandra from Apache" off \
    "NONE" "" on 3>&1 1>&2 2>&3
)

echo "Selected:" $CHOICE

if [[ $CHOICE == *"LANGUAGE"* ]] ; then
  echo "LANGUAGE"
  bash ${SETUPDIR}/language.sh
fi

if [[ $CHOICE == *"EXPLORER"* ]] ; then
  echo "EXPLORER"
  bash ${SETUPDIR}/explorer.sh
fi

if [[ $CHOICE == *"SHELLS"* ]] ; then
  echo "SHELLS"
  bash ${SETUPDIR}/shells.sh
fi

if [[ $CHOICE == *"EDITORS"* ]] ; then
  echo "EDITORS"
  bash ${SETUPDIR}/editors.sh
fi 

if [[ $CHOICE == *"PYTHON"* ]] ; then
  echo "PYTHON"
  bash ${SETUPDIR}/python.sh
fi

if [[ $CHOICE == *"NODE"* ]] ; then
  echo "NODE"
  bash ${SETUPDIR}/nodejs.sh
fi

if [[ $CHOICE == *"GO"* ]] ; then
  echo "GO"
  bash ${SETUPDIR}/go.sh
fi

if [[ $CHOICE == *"RUBY"* ]] ; then
  echo "RUBY"
  bash ${SETUPDIR}/ruby.sh
fi

if [[ $CHOICE == *"RUST"* ]] ; then
  echo "RUST"
  bash ${SETUPDIR}/rust.sh
fi

if [[ $CHOICE == *"DOTNET"* ]] ; then
  echo "DOTNET"
  bash ${SETUPDIR}/dotnet.sh
fi

if [[ $CHOICE == *"JAVA"* ]] ; then
  echo "JAVA"
  bash ${SETUPDIR}/java.sh
fi

if [[ $CHOICE == *"POWERSHELL"* ]] ; then
  echo "POWERSHELL"
  bash ${SETUPDIR}/powershell.sh
  bash ${SETUPDIR}/axurecli.sh
fi

if [[ $CHOICE == *"GUI"* ]] ; then
  echo "GUI"
  bash ${SETUPDIR}/gui.sh
fi

if [[ $CHOICE == *"DOCKER"* ]] ; then
  echo "DOCKER"
  bash ${SETUPDIR}/docker.sh
fi

if [[ $CHOICE == *"CASSANDRA"* ]] ; then
  echo "CASSANDRA"
  bash ${SETUPDIR}/cassandra.sh
fi

if [[ $CHOICE == "NONE" ]] ; then
  echo "NONE"
  whiptail --title "No selection" --msgbox "Please select your desired options using the SPACE bar and then hit ENTER to confirm." 8 80
  installmenu
fi
}

# main
processarguments  "$@"

if [ ! -f ~/.updated ]; then
    welcomeprompt
    continueprompt
    updatescriptprompt
else
    rm ~/.updated
fi

securitypatches
installmenu
byemessage

exit 0
